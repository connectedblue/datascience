---
title       : Car journey times in Bristol, UK
subtitle    : Understanding traffic profiles
author      : Chris Shaw
job         : 
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      # 
widgets     : [shiny]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# Load up project data
# This file must be compiled from the root directory for the analysis
#called bristoltraffic

library(ProjectTemplate)

load.project()

library(shiny)

```


## Introduction

* Bristol has deployed multiple sensors around the city and made data available in an open data project (https://opendata.bristol.gov.uk/)
* One dataset collects journey times from `r nrow(summary)` different routes, varying in length from r min(summary$distance_miles) to r max(summary$distance_miles) miles.  This data is collected every ten minutes, 24 hours a day, seven days a week.
* We introduce today a brand new application that makes use of the historical journey times data to build up a profile of average traffic conditions in Bristol for every hour in every day.
*  It's expected that this application will be used by commuters, small businesses and local government planners amongst others.
* The following slides demonstrate how the application works

---

## test

```{r test, echo = FALSE}

day <- "Tuesday"
hour <- 8
# Filter data based on user input
filteredData <- hourly_summary %>% filter(day==day, hour==hour)

# show the static map without the circle markers and mean city speed

map <- leaflet(hourly_summary) %>% addTiles() %>%
                fitBounds(~min(long), ~min(lat), ~max(long), ~max(lat)) 


city_speed <- function(data){
        round(sum(data$distance_miles)/
                      (sum(data$mean_travel_time.x)/3600),
              0)
}

time_format <- function (h) {
        
        period <- ifelse(h>=6 & h<=10, "Morning",
                  ifelse(h>=10 & h<17, "Afternoon",
                  ifelse(h>=17 & h<20, "Evening", "Nighttime")))
        h1<-h%%12
        if (h1==0) h1<-12
        h2<-(h1+1)%%12
        if (h2==0) h2<-12
        time <- paste0(h1," - ", h2, ifelse(h<12, "am", "pm"))
        list(period=period, time=time)
}

city_speed <- city_speed(filteredData) 
t_fmt<-time_format(hour)
period <- t_fmt$period
time <- t_fmt$time

title <- paste0("<big>",day, " ", period, "<br/>", time, "</big>"  )
map <- map %>%
        clearMarkers() %>%
        clearControls() %>%
        addCircleMarkers(
                ~long, ~lat,
                radius = 10,
                color = ~status,
                stroke = FALSE, fillOpacity = 0.5,
                popup = ~popup
        ) %>%
        addLegend("topright", colors=c(""),
                  title = "Ave City Speed",
                  labels=c(paste0("<big><big>", city_speed,"<b></big></big><big>&nbsp;mph</big></b>"))
        ) %>%
        addLegend("bottomright", title="Route status",
                  colors=c("red", "orange", "green"),
                  labels=c("Congested<br/>", "Slow<BR/>", "Normal"),
                  opacity=0.5
        ) %>%
        addLegend("bottomleft", title=title,colors=c(""),
                  labels=c("")
        ) 


map

```


---

```{r plot, echo=F}

day <- "Tuesday"
hour <- 8
# Filter data based on user input
filteredData <- hourly_summary %>% filter(day==day, hour==hour)


city_speed <- function(data){
        round(sum(data$distance_miles)/
                      (sum(data$mean_travel_time.x)/3600),
              0)
}

time_format <- function (h) {
        
        period <- ifelse(h>=6 & h<=10, "Morning",
                  ifelse(h>=10 & h<17, "Afternoon",
                  ifelse(h>=17 & h<20, "Evening", "Nighttime")))
        h1<-h%%12
        if (h1==0) h1<-12
        h2<-(h1+1)%%12
        if (h2==0) h2<-12
        time <- paste0(h1," - ", h2, ifelse(h<12, "am", "pm"))
        list(period=period, time=time)
}



data <- filteredData
city_speed <- city_speed(data)
t_fmt<-time_format(hour)
period <- t_fmt$period
time <- t_fmt$time
title <- paste0(day, " ", period,": ", time)

data$label <- paste0(data$section_description, "ss:ss", data$mean_speed.x)
g<-ggplot(data,aes(x=reorder(section_description, -mean_speed.x), 
                   y=mean_speed.x)) +
           geom_bar(stat="identity",
                    fill=data$status) +
           xlab("Routes") + ylab("Average Speed (mph)") +
           coord_flip() +
           theme(axis.text.y=element_blank(),
                 axis.ticks.y=element_blank(),
                 panel.grid.minor=element_blank(), 
                 panel.grid.major=element_blank(),
                 panel.background = element_rect(fill = "cornsilk"),
                 panel.border = element_rect(fill="transparent", colour="black")) +
           geom_hline(yintercept = city_speed, linetype="dashed", colour="black", size=1) +
           ggtitle(paste0(title, ".  Average city speed: ", city_speed, "mph")               
    )
g
```


---



--- 

## The input screen


```

---

